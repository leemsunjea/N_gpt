#!/bin/bash
# CloudType 환경에서 필요한 라이브러리만 동적으로 설치

# 로그 디렉토리 생성
mkdir -p /tmp/logs

# 필요한 디렉토리 확인
echo "필요한 디렉토리 확인 중..."
mkdir -p /tmp/static
mkdir -p /tmp/templates

# 패키지 설치 건너뛰기 - 권한 문제 방지
echo "CloudType 환경에서는 패키지 설치를 건너뜁니다."

# 환경 변수 설정 - 외부 PostgreSQL 데이터베이스 사용
export CLOUDTYPE_DEPLOYMENT=1
export PYTHONUNBUFFERED=1

# 데이터베이스 연결 환경 변수
export DB_USER=${DB_USER:-"root"}
export DB_PASSWORD=${DB_PASSWORD:-"sunjea"}
export DB_HOST=${DB_HOST:-"svc.sel4.cloudtype.app"}
export DB_PORT=${DB_PORT:-"30173"}
export DB_NAME=${DB_NAME:-"testdb"}

# 임시 파비콘 파일 생성 (/tmp 디렉토리에는 쓰기 권한이 있음)
echo "임시 파비콘 파일 생성..."
touch /tmp/favicon.ico
export FAVICON_PATH="/tmp/favicon.ico"

# 연결 테스트용 로깅
echo "데이터베이스 연결 정보:"
echo "DB_USER: $DB_USER"
echo "DB_HOST: $DB_HOST"
echo "DB_PORT: $DB_PORT"
echo "DB_NAME: $DB_NAME"

# 서버 시작
echo "서버 시작 중..."
exec uvicorn main:app --host 0.0.0.0 --port $PORT --log-level debug
